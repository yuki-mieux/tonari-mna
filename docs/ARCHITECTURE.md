# HireMate - 技術アーキテクチャ

最終更新: 2025-12-09
タグ: #HireMate #技術設計 #アーキテクチャ

---

## 1. システム全体像

```
┌────────────────────────────────────────────────────────────────┐
│                        クライアント層                          │
├────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Chrome拡張   │  │ Webアプリ    │  │ Electronアプリ│        │
│  │ (MVP)        │  │ (Phase2)     │  │ (Phase3)     │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                 │                  │
│         └─────────────────┼─────────────────┘                  │
│                           │                                    │
│                    WebSocket / REST                            │
└───────────────────────────┼────────────────────────────────────┘
                            │
┌───────────────────────────┼────────────────────────────────────┐
│                        API層                                   │
├───────────────────────────┼────────────────────────────────────┤
│                           ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                   API Gateway                            │  │
│  │                   (Nginx / Cloudflare)                   │  │
│  └─────────────────────────┬───────────────────────────────┘  │
│                            │                                   │
│            ┌───────────────┼───────────────┐                  │
│            ▼               ▼               ▼                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │ WebSocket   │  │ REST API    │  │ 認証サービス │           │
│  │ Server      │  │ Server      │  │ (Auth0/     │           │
│  │ (FastAPI)   │  │ (FastAPI)   │  │  Supabase)  │           │
│  └──────┬──────┘  └──────┬──────┘  └─────────────┘           │
│         │                │                                    │
└─────────┼────────────────┼────────────────────────────────────┘
          │                │
┌─────────┼────────────────┼────────────────────────────────────┐
│         │     バックエンド処理層                              │
├─────────┼────────────────┼────────────────────────────────────┤
│         ▼                ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                Message Queue (Redis)                     │  │
│  └────────────────────────┬────────────────────────────────┘  │
│                           │                                   │
│         ┌─────────────────┼─────────────────┐                │
│         ▼                 ▼                 ▼                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ 音声認識    │  │ アドバイス  │  │ マッチング  │          │
│  │ Worker      │  │ Worker      │  │ Worker      │          │
│  │             │  │             │  │             │          │
│  │ Whisper API │  │ Claude API  │  │ Claude API  │          │
│  │ / Deepgram  │  │             │  │ + RAG       │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                               │
└───────────────────────────────────────────────────────────────┘
                            │
┌───────────────────────────┼───────────────────────────────────┐
│                       データ層                                │
├───────────────────────────┼───────────────────────────────────┤
│         ┌─────────────────┼─────────────────┐                │
│         ▼                 ▼                 ▼                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ PostgreSQL  │  │ Qdrant      │  │ Redis       │          │
│  │ (Supabase)  │  │ (Vector DB) │  │ (Cache)     │          │
│  │             │  │             │  │             │          │
│  │ ・面接データ │  │ ・求人埋込み │  │ ・セッション │          │
│  │ ・求人マスタ │  │ ・候補者履歴 │  │ ・会話バッファ│         │
│  │ ・ユーザー  │  │             │  │             │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 2. 技術スタック

### 2.1 フロントエンド

| レイヤー | 技術 | 理由 |
|----------|------|------|
| MVP | Chrome拡張 (Manifest V3) | 面接ツールと同時利用、開発速度 |
| UI | React + TypeScript | 型安全、コンポーネント再利用 |
| スタイル | Tailwind CSS | 高速開発、一貫したデザイン |
| 状態管理 | Zustand | シンプル、軽量 |
| 音声キャプチャ | Web Audio API / chrome.tabCapture | ブラウザ音声取得 |

### 2.2 バックエンド

| レイヤー | 技術 | 理由 |
|----------|------|------|
| API | FastAPI (Python) | 高速、WebSocket対応、型ヒント |
| WebSocket | FastAPI WebSocket | 双方向リアルタイム通信 |
| Queue | Redis Streams | 軽量、高速、Pub/Sub |
| Worker | Celery or 独自Worker | 非同期処理 |

### 2.3 AI/ML

| 機能 | 技術 | 理由 |
|------|------|------|
| 音声認識 | Deepgram API | 低遅延（<1秒）、日本語対応、話者分離 |
| アドバイス生成 | Claude API (claude-3-5-haiku) | 高速、コスト効率 |
| マッチング | Claude API + RAG | 理由付きマッチング |
| 埋め込み | Voyage AI / OpenAI | 高品質ベクトル |
| Vector DB | Qdrant | 高速検索、フィルタリング |

### 2.4 インフラ

| レイヤー | 技術 | 理由 |
|----------|------|------|
| ホスティング | Fly.io or Railway | 簡単デプロイ、WebSocket対応 |
| DB | Supabase | PostgreSQL + Auth + Realtime |
| CDN | Cloudflare | 高速配信、DDoS対策 |
| 監視 | Sentry + Datadog | エラー追跡、パフォーマンス |

---

## 3. コンポーネント詳細

### 3.1 音声認識パイプライン

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Chrome拡張  │───▶│ WebSocket   │───▶│ 音声認識    │───▶│ テキスト    │
│ 音声キャプチャ│    │ Server      │    │ Worker      │    │ 配信        │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
      │                  │                  │                  │
      │ Audio Chunk      │ Audio Queue      │ Deepgram API     │ Transcript
      │ (Base64)         │ (Redis)          │                  │ (WebSocket)
      ▼                  ▼                  ▼                  ▼
  16kHz, Mono       バッファリング      リアルタイムSTT     クライアント
  100ms chunks      250ms単位          <1秒遅延            へ配信
```

**音声フォーマット**:
- サンプルレート: 16kHz
- チャンネル: Mono
- フォーマット: PCM 16bit / Opus
- チャンクサイズ: 100ms

**Deepgram設定**:
```python
options = {
    "model": "nova-2",
    "language": "ja",
    "punctuate": True,
    "diarize": True,  # 話者分離
    "interim_results": True,  # 途中結果
    "endpointing": 300,  # 発話終了検知
}
```

### 3.2 アドバイス生成エンジン

```
┌─────────────────────────────────────────────────────────────┐
│                   アドバイス生成フロー                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                           │
│  │ 会話バッファ │  直近5分の会話                            │
│  │ (Redis)     │                                           │
│  └──────┬──────┘                                           │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ トリガー判定 │  30秒無発言 or 話題転換時                 │
│  └──────┬──────┘                                           │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Claude API (claude-3-5-haiku)                        │   │
│  │                                                       │   │
│  │ System: あなたは面接アドバイザーです。               │   │
│  │         以下の会話を分析し、面接官へのアドバイスを   │   │
│  │         1つだけ、50文字以内で提案してください。      │   │
│  │                                                       │   │
│  │ User: [直近5分の会話]                                │   │
│  └──────┬──────────────────────────────────────────────┘   │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ WebSocket   │  クライアントへ配信                       │
│  │ 配信        │                                           │
│  └─────────────┘                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**アドバイスプロンプト例**:
```python
ADVICE_SYSTEM_PROMPT = """
あなたは派遣会社の面接アドバイザーです。
面接の会話をリアルタイムで分析し、面接官に役立つアドバイスを提供します。

アドバイスの種類:
1. 深掘り提案: 候補者の発言をより詳しく聞くべきポイント
2. 質問提案: 次に聞くべき質問
3. 注意喚起: 候補者の懸念や不安のサイン
4. ポジティブ: 良い質問や進行へのフィードバック

ルール:
- 1つのアドバイスのみ
- 50文字以内
- 具体的で実行可能な内容
- 面接の流れを妨げない
"""
```

### 3.3 求人マッチングエンジン

```
┌─────────────────────────────────────────────────────────────┐
│                   マッチングフロー                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐                        │
│  │ 会話バッファ │───▶│ 候補者情報  │  スキル、経験、希望    │
│  │ (Redis)     │    │ 抽出        │                        │
│  └─────────────┘    └──────┬──────┘                        │
│                            │                                │
│                            ▼                                │
│                     ┌─────────────┐                        │
│                     │ 埋め込み生成 │  Voyage AI             │
│                     └──────┬──────┘                        │
│                            │                                │
│                            ▼                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Qdrant ベクトル検索                                  │   │
│  │                                                       │   │
│  │ - 類似度検索 (TOP 10)                                │   │
│  │ - フィルタ: 充足状況、勤務地、給与レンジ            │   │
│  └──────┬──────────────────────────────────────────────┘   │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Claude API (リランキング + 理由生成)                 │   │
│  │                                                       │   │
│  │ 候補10件 → TOP 3に絞り込み                          │   │
│  │ 各求人に「なぜマッチするか」の理由を生成            │   │
│  └──────┬──────────────────────────────────────────────┘   │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ WebSocket   │  TOP 3 + 理由をクライアントへ             │
│  │ 配信        │                                           │
│  └─────────────┘                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**マッチングスコア計算**:
```python
def calculate_match_score(candidate_profile, job_posting):
    """
    マッチングスコア =
        0.4 * スキルマッチ度 +
        0.2 * 経験年数マッチ度 +
        0.2 * 条件マッチ度（給与、勤務地）+
        0.1 * 急募度 +
        0.1 * セマンティック類似度
    """
    pass
```

---

## 4. データフロー

### 4.1 面接セッション全体

```
[面接開始]
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 1. セッション初期化                                         │
│    - interview_id 発行                                      │
│    - Redis にセッション作成                                 │
│    - 求人データをQdrantにロード（未ロードの場合）          │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. リアルタイム処理ループ                                   │
│                                                             │
│    ┌──────────────────────────────────────────────────┐    │
│    │ 音声チャンク受信 (100ms)                          │    │
│    └───────────────────────┬──────────────────────────┘    │
│                            │                                │
│    ┌───────────────────────▼──────────────────────────┐    │
│    │ 音声認識 (Deepgram) → テキスト配信               │    │
│    └───────────────────────┬──────────────────────────┘    │
│                            │                                │
│    ┌───────────────────────▼──────────────────────────┐    │
│    │ 会話バッファ更新 (Redis)                          │    │
│    └───────────────────────┬──────────────────────────┘    │
│                            │                                │
│         ┌──────────────────┴──────────────────┐            │
│         ▼                                     ▼            │
│    ┌─────────────┐                     ┌─────────────┐    │
│    │ アドバイス  │ (30秒ごと)          │ マッチング  │    │
│    │ 生成・配信  │                     │ 更新・配信  │    │
│    └─────────────┘                     └─────────────┘    │
│                                             (1分ごと)       │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. 面接終了                                                 │
│    - 会話ログをPostgreSQLに保存                            │
│    - サマリー生成（非同期）                                │
│    - Redisセッション削除                                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. MVP実装計画（今夜のフリーレ）

### 5.1 スコープ

**IN**:
- Chrome拡張（音声キャプチャ + UI）
- FastAPI WebSocket サーバー
- Deepgram 音声認識
- Claude アドバイス生成
- 固定の求人データ（10件）でマッチング

**OUT**:
- 認証
- データベース永続化
- ダッシュボード
- 話者分離

### 5.2 ディレクトリ構成（MVP）

```
hiremate/
├── extension/                 # Chrome拡張
│   ├── manifest.json
│   ├── popup/
│   │   ├── popup.html
│   │   ├── popup.css
│   │   └── popup.js
│   ├── content/
│   │   └── content.js        # 音声キャプチャ
│   ├── background/
│   │   └── background.js     # WebSocket管理
│   └── assets/
│       └── icon.png
│
├── backend/                   # FastAPI
│   ├── main.py               # エントリポイント
│   ├── config.py             # 設定
│   ├── api/
│   │   ├── websocket.py      # WebSocketハンドラ
│   │   └── rest.py           # REST API
│   ├── services/
│   │   ├── transcription.py  # Deepgram連携
│   │   ├── advice.py         # アドバイス生成
│   │   └── matching.py       # 求人マッチング
│   ├── data/
│   │   └── sample_jobs.json  # サンプル求人
│   └── requirements.txt
│
├── docs/
│   ├── REQUIREMENTS.md
│   └── ARCHITECTURE.md
│
└── README.md
```

### 5.3 実装順序

1. **Backend基盤** (30分)
   - FastAPI セットアップ
   - WebSocket エンドポイント
   - 設定ファイル

2. **音声認識** (30分)
   - Deepgram 連携
   - ストリーミング処理

3. **Chrome拡張** (1時間)
   - Manifest V3 設定
   - 音声キャプチャ
   - WebSocket 接続
   - 基本UI

4. **アドバイス生成** (30分)
   - Claude API 連携
   - プロンプト設計

5. **マッチング** (30分)
   - サンプル求人データ
   - 基本的なマッチングロジック

6. **統合テスト** (30分)
   - E2E動作確認
   - バグ修正

---

## 6. セキュリティ考慮事項

### 6.1 音声データ
- TLS 1.3 で暗号化通信
- 音声データは処理後即削除（メモリ上のみ）
- 面接終了後、テキストのみ保存（音声は破棄）

### 6.2 API キー
- 環境変数で管理
- クライアントに露出しない
- ローテーション対応

### 6.3 認証（Phase 2）
- Supabase Auth または Auth0
- JWT トークン
- リフレッシュトークン

---

## 参考情報

- Deepgram Docs: https://developers.deepgram.com/
- Claude API: https://docs.anthropic.com/
- Chrome Extension MV3: https://developer.chrome.com/docs/extensions/mv3/
- FastAPI WebSocket: https://fastapi.tiangolo.com/advanced/websockets/
